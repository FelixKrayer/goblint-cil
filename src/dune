(include_subdirs unqualified)

(library
  (public_name goblint-cil)
  (name cil)
  (wrapped false) ; this should be changed, but then module paths in goblint need to be prefixed
  (libraries zarith findlib dynlink unix str stdlib-shims batteries.unthreaded) ; batteries shouldn't be needed, but tests fail on MacOS otherwise: https://github.com/goblint/cil/pull/89#issuecomment-1092610041
  (modules (:standard \ main))
)

; HACK: workaround for https://github.com/ocaml/dune/issues/3374
(rule (action (copy ../src__machdep-ml.c machdep-ml.c)))
(rule (action (copy ../src__cilversion.ml cilversion.ml)))

(rule
 (alias machdep)
 (deps (alias ../configure) machdep-ml.c)
 (targets machdep.ml)
 (locks ../make)
 (action (chdir .. (progn
  (run make machdep)
  (run cp _build/machdep.ml src)))))

(ocamllex formatlex)
(ocamlyacc formatparse)

(executable
 (name main)
 (modules main)
 (modes native)
 (libraries goblint-cil)
 (flags :standard -linkall))

(env
  (dev
    (flags (:standard -warn-error -A -w -27-32-34-37-38)) ; https://dune.readthedocs.io/en/stable/faq.html#how-to-make-warnings-non-fatal
  )
)
