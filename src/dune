(include_subdirs unqualified)

(library
  (public_name goblint-cil)
  (name cil)
  (wrapped false) ; this should be changed, but then module paths in goblint need to be prefixed
  (libraries zarith findlib dynlink unix str stdlib-shims batteries.unthreaded) ; batteries shouldn't be needed, but tests fail on MacOS otherwise: https://github.com/goblint/cil/pull/89#issuecomment-1092610041
  (modules (:standard \ main))
)

; HACK: workaround for https://github.com/ocaml/dune/issues/3374
(rule (action (copy ../src__machdep-ml.c machdep-ml.c)))
(rule (action (copy ../src__cilversion.ml cilversion.ml)))

(rule
 (deps (alias ../configure) machdep-ml.c)
 (target machdep-ml.exe)
 (action (run %{cc} -D_GNUCC machdep-ml.c -o %{target})))

(rule
 (target machdep.ml)
 (action (with-stdout-to %{target} (progn
  (echo "include Machdep0\n")
  (echo "let gcc = {\n")
  (run ./machdep-ml.exe)
  (echo "}\n")
  (echo "let theMachine : mach ref = ref gcc\n")))))

(ocamllex formatlex)
(ocamlyacc formatparse)

(executable
 (name main)
 (modules main)
 (modes native)
 (libraries goblint-cil)
 (flags :standard -linkall))

(env
  (dev
    (flags (:standard -warn-error -A -w -27-32-34-37-38)) ; https://dune.readthedocs.io/en/stable/faq.html#how-to-make-warnings-non-fatal
  )
)
